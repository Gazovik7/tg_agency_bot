<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¢–µ—Å—Ç–æ–≤–æ–µ –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ</title>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1 class="dashboard-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¢–µ—Å—Ç–æ–≤–æ–µ –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ</h1>
                <p class="dashboard-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
            </div>
            <div>
                <span class="badge bg-primary" id="currentPeriod">–ü–µ—Ä–∏–æ–¥: 2025-05-01 - 2025-05-25</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">–§–∏–ª—å—Ç—Ä—ã</h2>
            </div>
            <div class="card-body">
                <form id="filtersForm" class="filters-container">
                    <div class="form-group">
                        <label for="chatFilter" class="form-label">–ß–∞—Ç:</label>
                        <select class="form-select" id="chatFilter" name="chat_id">
                            <option value="">–í—Å–µ —á–∞—Ç—ã</option>
                            <!-- Options will be populated via JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="employeeFilter" class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
                        <select class="form-select" id="employeeFilter" name="employee_id">
                            <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                            <!-- Options will be populated via JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="startDate" class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
                        <input type="date" class="form-control" id="startDate" name="start_date">
                    </div>

                    <div class="form-group">
                        <label for="endDate" class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
                        <input type="date" class="form-control" id="endDate" name="end_date">
                    </div>

                    <div class="form-group d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            </div>
            <div class="card-body">
                <div class="grid">
                    <div class="stat-card">
                        <div class="stat-title">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                        <div class="stat-value" id="totalMessagesStats">0</div>
                        <div class="stat-description">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–í—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤</div>
                        <div class="stat-value" id="totalSymbolsStats">0</div>
                        <div class="stat-description">–û–±—â–∏–π –æ–±—ä–µ–º –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–°–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã</div>
                        <div class="stat-value" id="teamMessagesStats">0</div>
                        <div class="stat-description" id="teamMessagesPercent">56% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–°–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                        <div class="stat-value" id="clientMessagesStats">0</div>
                        <div class="stat-description" id="clientMessagesPercent">44% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                        <div class="stat-value" id="avgResponseStats">0 –º–∏–Ω</div>
                        <div class="stat-description">–í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏ –∫–æ–º–∞–Ω–¥—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                        <div class="stat-value" id="maxResponseStats">0 –º–∏–Ω</div>
                        <div class="stat-description">–°–∞–º—ã–π –¥–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π -->
        <div class="tab-container">
            <ul class="tabs" id="analytics-tabs">
                <li class="tab-item active" data-tab="employees">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</li>
                <li class="tab-item" data-tab="clients">–ö–ª–∏–µ–Ω—Ç—ã</li>
                <li class="tab-item" data-tab="activity">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</li>
                <li class="tab-item" data-tab="sentiment">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</li>
                <li class="tab-item" data-tab="communications">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</li>
            </ul>

            <div class="tab-content">
                <!-- –í–∫–ª–∞–¥–∫–∞ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ -->
                <div class="tab-pane active" id="employees">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="employeeActivityChart"></div>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –ö–ª–∏–µ–Ω—Ç—ã -->
                <div class="tab-pane" id="clients">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–ù–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                                            <th>–°–æ–æ–±—â–µ–Ω–∏–π</th>
                                            <th>–°–∏–º–≤–æ–ª–æ–≤</th>
                                            <th>–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activeClientsTable">
                                        <!-- Active clients data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
                <div class="tab-pane" id="activity">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="activityChart"></div>
                        </div>
                    </div>
                </div>

            <!-- Sentiment Tab -->
            <div class="tab-pane fade" id="sentiment" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Sentiment Distribution</h5>
                            </div>
                            <div class="card-body">
                                <div id="sentimentChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Sentiment Trend</h5>
                            </div>
                            <div class="card-body">
                                <div id="sentimentTrendChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Performance Tab -->
            <div class="tab-pane fade" id="team" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5>Team Member Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Role</th>
                                        <th>Messages</th>
                                        <th>Avg Response Time</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody id="teamPerformanceTable">
                                    <!-- Team performance data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Tab -->
            <div class="tab-pane fade" id="clients" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5>Most Active Clients</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Client</th>
                                                <th>Messages</th>
                                                <th>Last Message</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activeClientsTable">
                                            <!-- Active clients data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Client Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <h6>Unique Clients (24h)</h6>
                                    <h3 class="text-primary" id="uniqueClients">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communications Tab -->
            <div class="tab-pane fade" id="communications" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5>Communication Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="communicationsChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h6>Key Metrics</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Client to Team Ratio</span>
                                        <span id="clientTeamRatio">1:1</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Messages per Hour</span>
                                        <span id="messagesPerHour">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Peak Hour</span>
                                        <span id="peakHour">-</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading dashboard data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="errorMessage">
                    An error occurred while loading data.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="retryBtn">Retry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    
    <script>
        // Set admin token from server
        window.ADMIN_TOKEN = {{ admin_token|tojson }};
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for all scripts to load
            setTimeout(function() {
                if (typeof DashboardManager !== 'undefined' && !window.dashboardManager) {
                    window.dashboardManager = new DashboardManager();
                    
                    // Expose loadDashboardData globally for error modal retry
                    window.loadDashboardData = function() {
                        if (window.dashboardManager) {
                            window.dashboardManager.loadDashboardData();
                        }
                    };
                }
            }, 100);
        });
    </script>
</body>
</html>
