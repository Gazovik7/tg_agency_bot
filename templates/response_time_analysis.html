<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/plotly.js@2.18.0/dist/plotly.min.css" rel="stylesheet">
    <style>
        .metric-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .alert-critical { border-left: 5px solid #dc3545; }
        .alert-high { border-left: 5px solid #fd7e14; }
        .alert-medium { border-left: 5px solid #ffc107; }
        .alert-low { border-left: 5px solid #198754; }
        .response-time-good { color: #198754; font-weight: bold; }
        .response-time-warning { color: #ffc107; font-weight: bold; }
        .response-time-danger { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">üìä –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞</h1>
                
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">–§–∏–ª—å—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞</h5>
                        <form id="filterForm" class="row">
                            <div class="col-md-3">
                                <label for="chatSelect" class="form-label">–ß–∞—Ç</label>
                                <select class="form-select" id="chatSelect">
                                    <option value="">–í—Å–µ —á–∞—Ç—ã</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="employeeSelect" class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                                <select class="form-select" id="employeeSelect">
                                    <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="startDate" class="form-label">–ù–∞—á–∞–ª–æ</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-2">
                                <label for="endDate" class="form-label">–ö–æ–Ω–µ—Ü</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary d-block w-100">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- –ê–ª–µ—Ä—Ç—ã –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ -->
                <div class="card mb-4" id="alertsCard" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">üö® –ê–ª–µ—Ä—Ç—ã –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</h5>
                        <div id="alertsContainer"></div>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
                <div class="row" id="metricsContainer">
                    <!-- –ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ -->
                <div class="card mb-4" id="chartCard" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞</h5>
                        <div id="responseTimeChart" style="height: 400px;"></div>
                    </div>
                </div>

                <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
                <div class="card" id="detailsCard" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="detailsTable">
                                <thead>
                                    <tr>
                                        <th>–ß–∞—Ç/–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                        <th>–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤</th>
                                        <th>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</th>
                                        <th>–ú–µ–¥–∏–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</th>
                                        <th>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</th>
                                        <th>–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã (&lt;5–º–∏–Ω)</th>
                                        <th>–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (&gt;1—á–∞—Å)</th>
                                    </tr>
                                </thead>
                                <tbody id="detailsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.18.0/dist/plotly.min.js"></script>
    <script>
        const API_BASE = '';
        const AUTH_TOKEN = '771G@zoviK';

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        async function loadFilters() {
            try {
                const response = await fetch('/api/filter-options', {
                    headers: { 'X-Admin-Token': AUTH_TOKEN }
                });
                const data = await response.json();

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —á–∞—Ç—ã
                const chatSelect = document.getElementById('chatSelect');
                data.chats.forEach(chat => {
                    const option = document.createElement('option');
                    option.value = chat.id;
                    option.textContent = chat.title;
                    chatSelect.appendChild(option);
                });

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                const employeeSelect = document.getElementById('employeeSelect');
                data.employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    employeeSelect.appendChild(option);
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤
        async function loadAlerts() {
            try {
                const response = await fetch('/api/slow-response-alerts?hours=24', {
                    headers: { 'X-Admin-Token': AUTH_TOKEN }
                });
                const data = await response.json();

                if (data.alerts && data.alerts.length > 0) {
                    displayAlerts(data.alerts);
                    document.getElementById('alertsCard').style.display = 'block';
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤:', error);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤
        function displayAlerts(alerts) {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '';

            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.alert_level} alert-${alert.alert_level}`;
                alertDiv.innerHTML = `
                    <strong>${alert.chat_title}</strong><br>
                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: <span class="response-time-danger">${alert.max_response_time_minutes} –º–∏–Ω</span><br>
                    –ú–µ–¥–∏–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: <span class="response-time-warning">${alert.median_response_time_minutes} –º–∏–Ω</span><br>
                    –ú–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (>1—á): ${alert.responses_over_1hour} –∏–∑ ${alert.total_responses}
                `;
                container.appendChild(alertDiv);
            });
        }

        // –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
        async function analyzeResponseTime() {
            const chatId = document.getElementById('chatSelect').value;
            const employeeId = document.getElementById('employeeSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let url = '/api/response-time-analysis?';
            const params = new URLSearchParams();
            
            if (chatId) params.append('chat_id', chatId);
            if (employeeId) params.append('employee_id', employeeId);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            try {
                const response = await fetch(url + params.toString(), {
                    headers: { 'X-Admin-Token': AUTH_TOKEN }
                });
                const data = await response.json();

                displayMetrics(data);
                
                if (data.type === 'overall') {
                    displayDetailedTable(data.metrics.chat_analyses);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        function displayMetrics(data) {
            const container = document.getElementById('metricsContainer');
            container.innerHTML = '';

            let metrics;
            if (data.type === 'overall') {
                // –î–ª—è –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const totalResponses = data.metrics.total_responses;
                container.innerHTML = `
                    <div class="col-12">
                        <h5>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º</h5>
                        <p>–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤: ${totalResponses}</p>
                        <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤: ${data.metrics.chat_analyses.length}</p>
                    </div>
                `;
                return;
            } else {
                metrics = data.metrics;
            }

            if (!metrics || metrics.total_responses === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ</div></div>';
                return;
            }

            // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
            container.innerHTML = `
                <div class="col-md-3">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <h6 class="card-title">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</h6>
                            <h3 class="${getResponseTimeClass(metrics.avg_response_time_minutes)}">${metrics.avg_response_time_minutes || 0} –º–∏–Ω</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <h6 class="card-title">–ú–µ–¥–∏–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</h6>
                            <h3 class="${getResponseTimeClass(metrics.median_response_time_minutes)}">${metrics.median_response_time_minutes || 0} –º–∏–Ω</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <h6 class="card-title">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</h6>
                            <h3 class="${getResponseTimeClass(metrics.max_response_time_minutes)}">${metrics.max_response_time_minutes || 0} –º–∏–Ω</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <h6 class="card-title">–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤</h6>
                            <h3 class="text-primary">${metrics.total_responses}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card metric-card">
                        <div class="card-body">
                            <h6 class="card-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="response-time-good">–î–æ 5 –º–∏–Ω—É—Ç</div>
                                    <strong>${metrics.responses_under_5min} (${metrics.percentage_under_5min}%)</strong>
                                </div>
                                <div class="col-6">
                                    <div class="response-time-warning">–î–æ 15 –º–∏–Ω—É—Ç</div>
                                    <strong>${metrics.responses_under_15min} (${metrics.percentage_under_15min}%)</strong>
                                </div>
                            </div>
                            <hr>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="response-time-warning">–î–æ 1 —á–∞—Å–∞</div>
                                    <strong>${metrics.responses_under_1hour} (${metrics.percentage_under_1hour}%)</strong>
                                </div>
                                <div class="col-6">
                                    <div class="response-time-danger">–ë–æ–ª—å—à–µ 1 —á–∞—Å–∞</div>
                                    <strong>${metrics.responses_over_1hour} (${metrics.percentage_over_1hour}%)</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card metric-card">
                        <div class="card-body">
                            <h6 class="card-title">–ü–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div>75-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å</div>
                                    <strong>${metrics.p75_response_time_minutes || 0} –º–∏–Ω</strong>
                                </div>
                                <div class="col-4">
                                    <div>90-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å</div>
                                    <strong>${metrics.p90_response_time_minutes || 0} –º–∏–Ω</strong>
                                </div>
                                <div class="col-4">
                                    <div>95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å</div>
                                    <strong>${metrics.p95_response_time_minutes || 0} –º–∏–Ω</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            createResponseTimeChart(metrics);
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ CSS –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
        function getResponseTimeClass(minutes) {
            if (!minutes) return 'text-muted';
            if (minutes <= 5) return 'response-time-good';
            if (minutes <= 60) return 'response-time-warning';
            return 'response-time-danger';
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
        function createResponseTimeChart(metrics) {
            const chartData = [{
                x: ['–î–æ 5 –º–∏–Ω', '–î–æ 15 –º–∏–Ω', '–î–æ 1 —á–∞—Å–∞', '–ë–æ–ª—å—à–µ 1 —á–∞—Å–∞'],
                y: [metrics.responses_under_5min, metrics.responses_under_15min, metrics.responses_under_1hour, metrics.responses_over_1hour],
                type: 'bar',
                marker: {
                    color: ['#198754', '#ffc107', '#fd7e14', '#dc3545']
                }
            }];

            const layout = {
                title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞',
                xaxis: { title: '–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞' },
                yaxis: { title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤' }
            };

            Plotly.newPlot('responseTimeChart', chartData, layout);
            document.getElementById('chartCard').style.display = 'block';
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
        function displayDetailedTable(chatAnalyses) {
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';

            chatAnalyses.forEach(analysis => {
                const row = document.createElement('tr');
                const metrics = analysis.metrics;
                
                row.innerHTML = `
                    <td>${analysis.chat_title}</td>
                    <td>${metrics.total_responses}</td>
                    <td class="${getResponseTimeClass(metrics.avg_response_time_minutes)}">${metrics.avg_response_time_minutes || 0} –º–∏–Ω</td>
                    <td class="${getResponseTimeClass(metrics.median_response_time_minutes)}">${metrics.median_response_time_minutes || 0} –º–∏–Ω</td>
                    <td class="${getResponseTimeClass(metrics.max_response_time_minutes)}">${metrics.max_response_time_minutes || 0} –º–∏–Ω</td>
                    <td><span class="badge bg-success">${metrics.responses_under_5min} (${metrics.percentage_under_5min}%)</span></td>
                    <td><span class="badge bg-danger">${metrics.responses_over_1hour} (${metrics.percentage_over_1hour}%)</span></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('detailsCard').style.display = 'block';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            analyzeResponseTime();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            loadAlerts();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            analyzeResponseTime();
        });
    </script>
</body>
</html>