<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ {{ agency_name }}</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1 class="dashboard-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ {{ agency_name }}</h1>
                <p class="dashboard-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ ({{ timezone }})</p>
            </div>
            <div>
                <span class="badge bg-primary">–ü–µ—Ä–∏–æ–¥: {{ start_date }} - {{ end_date }}</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">–§–∏–ª—å—Ç—Ä—ã</h2>
            </div>
            <div class="card-body">
                <form method="POST" class="filters-container">
                    <div class="form-group">
                        <label for="chat_title" class="form-label">–ß–∞—Ç:</label>
                        <select name="chat_title" id="chat_title" class="form-select">
                            <option value="all">–í—Å–µ —á–∞—Ç—ã</option>
                            {% for title in all_chats %}
                                <option value="{{ title }}" {% if title == selected_chat %}selected{% endif %}>{{ title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="staff_username" class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
                        <select name="staff_username" id="staff_username" class="form-select">
                            <option value="all">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                            {% for username in all_staff %}
                                <option value="{{ username }}" {% if username == selected_staff %}selected{% endif %}>{{ username }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="start_date" class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}" required>
                    </div>

                    <div class="form-group">
                        <label for="end_date" class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}" required>
                    </div>

                    <div class="form-group d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            </div>
            <div class="card-body">
                {% if total_stats %}
                <div class="grid">
                    <div class="stat-card">
                        <div class="stat-title">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                        <div class="stat-value">{{ total_stats.total_messages | default(0) }}</div>
                        <div class="stat-description">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–í—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤</div>
                        <div class="stat-value">{{ total_stats.total_characters | default(0) }}</div>
                        <div class="stat-description">–û–±—â–∏–π –æ–±—ä–µ–º –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–°–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã</div>
                        <div class="stat-value">{{ total_stats.team_messages | default(0) }}</div>
                        <div class="stat-description">
                            {% if total_stats.total_messages and total_stats.total_messages > 0 %}
                                {{ ((total_stats.team_messages | default(0)) / total_stats.total_messages * 100)|round|int }}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞
                            {% else %}
                                0% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞
                            {% endif %}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–°–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                        <div class="stat-value">{{ total_stats.client_messages | default(0) }}</div>
                        <div class="stat-description">
                             {% if total_stats.total_messages and total_stats.total_messages > 0 %}
                                {{ ((total_stats.client_messages | default(0)) / total_stats.total_messages * 100)|round|int }}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞
                            {% else %}
                                0% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞
                            {% endif %}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                        <div class="stat-value">{{ "%.1f"|format(total_stats.avg_response_time|default(0)) }} –º–∏–Ω</div>
                        <div class="stat-description">–í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏ –∫–æ–º–∞–Ω–¥—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                        <div class="stat-value">{{ "%.1f"|format(total_stats.max_response_time|default(0)) }} –º–∏–Ω</div>
                        <div class="stat-description">–°–∞–º—ã–π –¥–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç</div>
                    </div>
                </div>
                {% else %}
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>
                {% endif %}
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å "–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è" -->
        {% if attention_needed and attention_needed|length > 0 %}
        <div class="card attention-card">
            <div class="card-header">
                <h2 class="card-title">‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</h2>
            </div>
            <div class="card-body">
                <div class="attention-grid">
                    {% for item in attention_needed %}
                    <div class="attention-item {{ item.status }}">
                        <div class="attention-header">
                            <h4 class="attention-title">{{ item.chat }}</h4>
                            <span class="attention-time">{{ item.last_message }}</span>
                        </div>
                        <div class="attention-body">
                            <div class="attention-stat">
                                <span class="attention-label">–ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:</span>
                                <span class="attention-value">{{ item.unanswered }}</span>
                            </div>
                            <div class="attention-stat">
                                <span class="attention-label">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</span>
                                <span class="attention-value">{{ item.sentiment|round(2) }}</span>
                            </div>
                            <div class="attention-stat">
                                <span class="attention-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é:</span>
                                <span class="attention-value">{{ item.activity }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –í–∫–ª–∞–¥–∫–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π -->
        <div class="tab-container">
            <ul class="tabs" id="analytics-tabs">
                <li class="tab-item active" data-tab="staff-tab">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</li>
                <li class="tab-item" data-tab="clients-tab">–ö–ª–∏–µ–Ω—Ç—ã</li>
                <li class="tab-item" data-tab="activity-tab">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</li>
                <li class="tab-item" data-tab="sentiment-tab">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</li>
                <li class="tab-item" data-tab="conversations-tab">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</li>
            </ul>

            <div class="tab-content">
                <!-- –í–∫–ª–∞–¥–∫–∞ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ -->
                <div class="tab-pane active" id="staff-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="staff-performance-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="staff-radar-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="staff-weekly-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h3>
                        </div>
                        <div class="card-body">
                            {% if staff_stats and staff_stats|length > 0 %}
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                            <th>–ß–∞—Ç</th>
                                            <th>–°–æ–æ–±—â–µ–Ω–∏–π</th>
                                            <th>–°–∏–º–≤–æ–ª–æ–≤</th>
                                            <th>–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for stat in staff_stats %}
                                        <tr>
                                            <td>{{ stat.username | default('N/A') }}</td>
                                            <td>{{ stat.chat | default('N/A') }}</td>
                                            <td>{{ stat.messages | default(0) }}</td>
                                            <td>{{ stat.characters | default(0) }}</td>
                                            <td>{{ "%.1f"|format(stat.avg_length|default(0)) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –ö–ª–∏–µ–Ω—Ç—ã -->
                <div class="tab-pane" id="clients-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –ø–æ –¥–Ω—è–º</h3>
                            <p class="card-subtitle">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∫–æ–º–∞–Ω–¥—ã —Å —Ç–µ—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏</p>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="client-dynamics-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º</h3>
                            <p class="card-subtitle">–¢—Ä–µ–Ω–¥—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –≤ —Ä–∞–∑—Ä–µ–∑–µ –Ω–µ–¥–µ–ª—å</p>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="client-weekly-dynamics-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="client-communication-chart"></div>
                        </div>
                    </div>

                     <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–ò–Ω–¥–µ–∫—Å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="loyalty-index-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="loyalty-trend-chart"></div>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
                <div class="tab-pane" id="activity-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="activity-timeline-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥—ã</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="team-heatmap-chart"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="client-heatmap-chart"></div>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å -->
                <div class="tab-pane" id="sentiment-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="sentiment-chart"></div>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ -->
                <div class="tab-pane" id="conversations-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π</h3>
                        </div>
                        <div class="card-body">
                            {% if conversations and conversations|length > 0 %}
                                {% for conversation in conversations %}
                                <div class="conversation-container">
                                    <h4 class="conversation-chat-title">{{ conversation.chat }}</h4>
                                    <div class="conversation-messages">
                                        {% for message in conversation.messages %}
                                        <div class="message {% if message.is_team %}message-team{% else %}message-client{% endif %}">
                                            <div class="message-header">
                                                <span class="message-username">{{ message.username }}</span>
                                                <span class="message-time">{{ message.timestamp }}</span>
                                            </div>
                                            <div class="message-body">
                                                {{ message.text }}
                                            </div>
                                            <div class="message-footer">
                                                <span class="message-sentiment
                                                    {% if message.sentiment == '–ü–æ–∑–∏—Ç–∏–≤–Ω–∞—è' %}sentiment-positive{% endif %}
                                                    {% if message.sentiment == '–ù–µ–≥–∞—Ç–∏–≤–Ω–∞—è' %}sentiment-negative{% endif %}
                                                    {% if message.sentiment == '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è' %}sentiment-neutral{% endif %}
                                                ">
                                                    {{ message.sentiment }}
                                                </span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function plotChart(chartId, chartDataJson) {
            const chartContainer = document.getElementById(chartId);
            if (!chartContainer) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω:", chartId);
                return;
            }
            if (chartDataJson) {
                try {
                    const chartData = JSON.parse(chartDataJson);
                    Plotly.newPlot(chartId, chartData.data, chartData.layout, {responsive: true});
                    console.log("–ì—Ä–∞—Ñ–∏–∫ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω:", chartId);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞ " + chartId + ":", e, "–î–∞–Ω–Ω—ã–µ:", chartDataJson);
                    chartContainer.innerHTML = `<p style="color:red; text-align:center; padding-top: 50px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞. –°–º. –∫–æ–Ω—Å–æ–ª—å (F12).</p>`;
                }
            } else {
                console.warn("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞:", chartId);
                chartContainer.innerHTML = "<p style='text-align:center; padding-top: 50px;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞.</p>";
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        plotChart('staff-performance-chart', {{ charts.staff_performance|tojson|safe }});
        plotChart('client-communication-chart', {{ charts.client_communication|tojson|safe }});
        plotChart('client-dynamics-chart', {{ charts.client_dynamics|tojson|safe }});
        plotChart('client-weekly-dynamics-chart', {{ charts.client_weekly_dynamics|tojson|safe }});
        plotChart('activity-timeline-chart', {{ charts.activity_timeline|tojson|safe }});
        plotChart('sentiment-chart', {{ charts.sentiment|tojson|safe }});
        plotChart('team-heatmap-chart', {{ charts.team_heatmap|tojson|safe }});
        plotChart('client-heatmap-chart', {{ charts.client_heatmap|tojson|safe }});
        plotChart('staff-radar-chart', {{ charts.staff_radar|tojson|safe }});
        plotChart('staff-weekly-chart', {{ charts.staff_weekly|tojson|safe }});
        plotChart('loyalty-index-chart', {{ charts.loyalty_index|tojson|safe }});
        plotChart('loyalty-trend-chart', {{ charts.loyalty_trend|tojson|safe }});


        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª–∞–¥–æ–∫
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab-item');
            const tabPanes = document.querySelectorAll('.tab-pane');

            if (tabs.length > 0 && tabPanes.length > 0) {
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        tabs.forEach(t => t.classList.remove('active'));
                        tabPanes.forEach(p => p.classList.remove('active'));

                        this.classList.add('active');
                        const tabId = this.getAttribute('data-tab');
                        const activePane = document.getElementById(tabId);
                        if (activePane) {
                            activePane.classList.add('active');
                            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ Plotly, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
                            // –≠—Ç–æ –≤–∞–∂–Ω–æ, —Ç.–∫. Plotly –º–æ–∂–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            window.dispatchEvent(new Event('resize'));
                        } else {
                            console.error("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–Ω–µ–ª—å –¥–ª—è –≤–∫–ª–∞–¥–∫–∏:", tabId);
                        }
                    });
                });
            } else {
                console.warn("–≠–ª–µ–º–µ–Ω—Ç—ã –≤–∫–ª–∞–¥–æ–∫ (.tab-item –∏–ª–∏ .tab-pane) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
            }
        });
    </script>

    <!-- –°—Ç–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–¥–µ—Å—å –∏–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ style.css -->
    <style>
        .attention-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .attention-item {
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-300);
        }
        .attention-item.warning { border-left: 4px solid var(--warning-color); }
        .attention-item.critical { border-left: 4px solid var(--danger-color); }
        .attention-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .attention-title { font-size: 1rem; font-weight: 600; margin: 0; }
        .attention-time { font-size: 0.8rem; color: var(--gray-500); }
        .attention-stat { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .attention-label { font-size: 0.9rem; color: var(--gray-600); }
        .attention-value { font-size: 0.9rem; font-weight: 600; }
        .card-subtitle { font-size: 0.9rem; color: var(--gray-600); margin-top: 0.25rem; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (–∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞) */
        .conversation-container { margin-bottom: 2rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius); overflow: hidden; }
        .conversation-chat-title { padding: 1rem; background-color: var(--gray-100); border-bottom: 1px solid var(--gray-300); font-size: 1.1rem; font-weight: 600; }
        .conversation-messages { padding: 1rem; max-height: 500px; overflow-y: auto; }
        .message { margin-bottom: 1rem; padding: 1rem; border-radius: 0.5rem; max-width: 80%; }
        .message-team { background-color: var(--primary-color); color: white; margin-left: auto; }
        .message-client { background-color: var(--gray-200); color: var(--gray-800); margin-right: auto; }
        .message-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem; }
        .message-username { font-weight: 600; }
        .message-time { color: var(--gray-500); /* –ë—ã–ª–æ opacity: 0.8;, –Ω–æ —Ü–≤–µ—Ç –ª—É—á—à–µ */ }
        .message-body { /* –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑ style.css */ margin-bottom: 0.5rem; word-break: break-word; }
        .message-footer { display: flex; justify-content: flex-end; margin-top: 0.5rem; font-size: 0.8rem; }
        .message-sentiment { padding: 0.2rem 0.5rem; border-radius: 0.25rem; }
        .sentiment-positive { background-color: var(--success-color); color: white; }
        .sentiment-negative { background-color: var(--danger-color); color: white; }
        .sentiment-neutral { background-color: var(--warning-color); color: white; }
        /* –ò–∑ –≤–∞—à–µ–≥–æ style.css - –Ω–µ–º–Ω–æ–≥–æ –¥—Ä—É–≥–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ —Ç–æ–∂–µ —Ä–∞–±–æ—á–∏–µ */
        /* .sentiment-positive { background-color: rgba(76, 175, 80, 0.2); color: #2e7d32; } */
        /* .sentiment-negative { background-color: rgba(244, 67, 54, 0.2); color: #c62828; } */
        /* .sentiment-neutral { background-color: rgba(255, 152, 0, 0.2); color: #ef6c00; } */
        .message-team .message-sentiment { background-color: rgba(255, 255, 255, 0.2); color: white; }
    </style>
</body>
</html>